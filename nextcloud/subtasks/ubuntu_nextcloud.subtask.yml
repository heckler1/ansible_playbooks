#Installs Nextcloud 12 on Ubuntu 16.04

- name: Install Ansible dependencies on Ubuntu
  raw: "sudo apt-get update -y && sudo apt-get install -y python aptitude"
  when: ansible_distribution == "Ubuntu"
  
- name: Set hostname
  hostname:
    name: '{{ hostname }}'

- name: Update repositories - Ubuntu
  apt:
    update_cache: yes

- name: Update installed packages - Ubuntu
  apt:
    upgrade: full

- name: Auto-remove orphaned dependencies and repo listings- Ubuntu
  apt:
    autoremove: yes
    autoclean: yes

- name: Install Nextcloud dependencies
  apt:
    name: '{{ item }}'
    state: latest
  with_items:
    - apache2
    - php
    - libapache2-mod-php
    - php-mcrypt
    - php-mysql
    - php-bz2
    - php-curl
    - php-gd
    - php-imagick
    - php-intl
    - php-mbstring
    - php-xml
    - php-zip
    - unzip

- include: subtasks/ubuntu_mysql.subtask.yml

- name: Create a database named "nextcloud"
  mysql_db:
    name: nextcloud
    state: present

- name: Create nextcloud database user
  mysql_user:
    name: nextcloud
    password: '{{ mysql_nextcloud_password }}'
    priv: 'nextcloud.*:ALL'
    state: present

- name: Reload privilege tables
  command: 'mysql -ne "FLUSH PRIVILEGES"'
  changed_when: False

- name: Restart Apache to load MySQL PHP extension, set Apache to start at boot
  systemd:
    name: apache2
    state: restarted
    enabled: yes
    
- name: Check if Nextcloud is already in the WebRoot
  stat:
    path: /var/www/html/index.php
  register: nextcloud_files

- name: Download and unzip Nextcloud
  when: nextcloud_files.stat.exists == False
  unarchive:
    src: https://download.nextcloud.com/server/releases/latest-12.zip
    dest: /var/www/
    remote_src: yes
        
- name: Move Nextcloud directory to WebRoot
  when: nextcloud_files.stat.exists == False
  command: '{{ item }}'
  with_items:
  - rm -r /var/www/html/
  - mv /var/www/nextcloud /var/www/html
  
- name: Create data directory
  file:
    path: /var/www/html/data
    state: directory
    
- name: Set ownership on WebRoot
  file: 
    path: /var/www/html/
    owner: www-data
    group: www-data
    recurse: yes
    state: directory

- name: Create cert directory
  file:
    path: /etc/apache2/ssl/
    state: directory
    
- name: Generate HTTPS Certs
  command: openssl req -new -nodes -x509 -subj "/C={{ country }}/ST={{ state }}/L={{ city }}/O={{ org }}/CN={{ hostname }}" -days 3650 -keyout /etc/apache2/ssl/nextcloud.key -out /etc/apache2/ssl/nextcloud.crt -extensions v3_ca creates=/etc/apache2/ssl/nextcloud.crt

- name: Enable Apache SSL Module
  apache2_module:
    name: '{{ item }}'
    state: present
  with_items: 
  - ssl
  - rewrite
  - headers
  
- name: Create Apache config file
  blockinfile:
    path: /etc/apache2/sites-available/nextcloud.conf
    create: yes
    block: |
      <VirtualHost *:443>
        ServerName {{ hostname }}
        ServerAlias {{ ansible_default_ipv4.address }}
        SSLEngine on
        SSLCertificateFile      /etc/apache2/ssl/nextcloud.crt
        SSLCertificateKeyFile /etc/apache2/ssl/nextcloud.key
        # HSTS (mod_headers is required) (15768000 seconds = 6 months)
        <IfModule mod_headers.c>
          Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
        </IfModule>
        # Prevent HTTP XSS Trace attack
        RewriteEngine on
        RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
        RewriteRule .* - [F]
      </VirtualHost>
      # SSL Configuration - generated by Mozilla
      SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
      SSLCipherSuite          ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
      SSLHonorCipherOrder     on
      SSLCompression          off
      # OCSP Stapling, only in httpd 2.3.3 and later
      SSLUseStapling          on
      SSLStaplingResponderTimeout 5
      SSLStaplingReturnResponderErrors off
      SSLStaplingCache        shmcb:/var/run/ocsp(128000)
      <Directory /var/www/html/>
        Options +FollowSymlinks
        AllowOverride All
        <IfModule mod_dav.c>
          Dav off
        </IfModule>
        SetEnv HOME /var/www/html
        SetEnv HTTP_HOME /var/www/html
      </Directory>
      Header edit Set-Cookie ^(.*)$ $1;HttpOnly;Secure

- name: Activate Apache config file
  file:
    src: /etc/apache2/sites-available/nextcloud.conf
    dest: /etc/apache2/sites-enabled/nextcloud.conf
    state: link

- name: Backup opcache.ini
  command: mv /etc/php/7.0/apache2/conf.d/10-opcache.ini /etc/php/7.0/apache2/conf.d/10-opcache.ini.bak
  
- name: Apply recommended opcache config
  blockinfile:
    path: /etc/php/7.0/apache2/conf.d/10-opcache.ini
    create: yes
    block: |
      zend_extension=opcache.so
      opcache.enable=1
      opcache.enable_cli=1
      opcache.interned_strings_buffer=8
      opcache.max_accelerated_files=10000
      opcache.memory_consumption=128
      opcache.save_comments=1
      opcache.revalidate_freq=1 

- name: Restart Apache to apply config changes
  systemd:
    name: apache2
    state: restarted

- name: Open firewall
  ufw:
    state: enabled
    port: '{{ item }}'
    proto: tcp
    rule: allow
  with_items:
  - 22
  - 443